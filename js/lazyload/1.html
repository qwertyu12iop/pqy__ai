<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片懒加载实现</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            color: #e0e0e0;
        }

        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .image-item {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s ease;
        }

        .image-item img[data-original] {
            opacity: 0.3;
        }

        .image-item img:not([data-original]) {
            opacity: 1;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #ff7e5f;
            animation: spin 1s linear infinite;
            position: absolute;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .debug-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #0af;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>图片懒加载实现</h1>
            <p class="subtitle">此页面演示了如何通过JavaScript实现图片的懒加载功能。当图片进入可视区域时，才会加载实际图片资源，从而优化页面性能。</p>
        </header>

        <div class="image-container">
            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250313/v2_15ad8ef9eca34830b4a2e081bbc7f57a@000000_oswg172644oswg1536oswg722_img_000?x-oss-process=image/resize,m_mfit,w_960,h_400,limit_0/crop,w_960,h_400,g_center"
                    alt="风景图片 1">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_aeaa7a1d51e74c3a8f909c96cd73a687@000000_oswg169950oswg1440oswg600_img_jpeg?x-oss-process=image/format,webp"
                    alt="风景图片 2">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_1c88dc26ff9341cf8738d670896ce3a8@5284654_oswg847922oswg1440oswg600_img_png?x-oss-process=image/resize,m_mfit,w_960,h_400,limit_0/crop,w_960,h_400,g_center/format,webp"
                    alt="风景图片 3">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_e1d92f43af2c4f47b8852ea8786e606f@6100851_oswg635095oswg1053oswg495_img_png?x-oss-process=image/resize,m_mfit,w_960,h_400,limit_0/crop,w_960,h_400,g_center/format,webp"
                    alt="风景图片 4">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250307/v2_9295b22d4a1b4b55ac4c3379b2da80cc@6100851_oswg781048oswg1053oswg495_img_png?x-oss-process=image/resize,m_mfit,w_600,h_400,limit_0/crop,w_600,h_400,g_center/format,webp"
                    alt="风景图片 5">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250306/v2_6ea048ac01c3408a9ed6ebe79a8fc8a2@5888275_oswg849213oswg1053oswg495_img_png?x-oss-process=image/resize,m_mfit,w_600,h_400,limit_0/crop,w_600,h_400,g_center/format,webp"
                    alt="风景图片 6">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_e4c73b024bcc409fba427adb2d7fb2fa@000000_oswg1251602oswg1080oswg559_img_000?x-oss-process=image/format,jpg/interlace,1"
                    alt="风景图片 7">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_9f21750bb37243128b6b1790f9072649@000000_oswg1219724oswg1080oswg601_img_000?x-oss-process=image/format,jpg/interlace,1"
                    alt="风景图片 8">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_2acf9b228cd940c1b5fdb5691c0b6e4c@000000_oswg1402679oswg1080oswg527_img_000?x-oss-process=image/format,jpg/interlace,1"
                    alt="风景图片 9">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250312/v2_af4dd443d261445d8e903c473cac074c@000000_oswg1118331oswg1080oswg497_img_000?x-oss-process=image/format,jpg/interlace,1"
                    alt="风景图片 10">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250313/v2_e7de1cc8e8014122ba303ea036eea532@1743780481_oswg58583oswg1080oswg257_img_000?x-oss-process=image/format,jpg/interlace,1"
                    alt="风景图片 11">
            </div>

            <div class="image-item">
                <img lazyload="true" src="https://static.360buyimg.com/item/main/1.0.12/css/i/loading.gif"
                    data-original="https://img.36krcdn.com/hsossms/20250313/v2_0f70e0a75a8d4736a050e846cd6ab3e5@1743780481_oswg183216oswg1080oswg629_img_000?x-oss-process=image/format,jpg/interlace,1"
                    alt="风景图片 12">
            </div>
        </div>

        <footer>
            <p>图片懒加载实现示例 | 滚动页面查看效果 | 修复了原代码中的加载问题</p>
        </footer>
    </div>

    <div class="debug-info">
        已加载图片: <span id="loaded-count">0</span>/12
    </div>

    <div class="loading-spinner" id="global-spinner"></div>

    <script>
        // 获取所有需要懒加载的图片元素
        const lazyImages = document.querySelectorAll('img[data-original][lazyload]');
        let loadedImageCount = 0;
        const totalImageCount = lazyImages.length;
        const debugInfo = document.getElementById('loaded-count');
        const globalSpinner = document.getElementById('global-spinner');

        // 更新调试信息
        function updateDebugInfo() {
            debugInfo.textContent = loadedImageCount;
        }

        // 显示全局加载指示器
        function showGlobalSpinner() {
            globalSpinner.style.display = 'block';
        }

        // 隐藏全局加载指示器
        function hideGlobalSpinner() {
            if (loadedImageCount >= totalImageCount) {
                globalSpinner.style.display = 'none';
            }
        }

        // 懒加载函数
        function lazyLoad() {
            // 获取可视区域高度
            const viewHeight = window.innerHeight || document.documentElement.clientHeight;

            lazyImages.forEach(img => {
                // 如果图片已经加载过，则跳过
                if (!img.hasAttribute('data-original')) return;

                // 获取图片位置信息
                const rect = img.getBoundingClientRect();

                // 检查图片是否在可视区域内
                const isInViewport = rect.top < viewHeight && rect.bottom >= 0;

                if (isInViewport) {
                    // 显示全局加载指示器
                    showGlobalSpinner();

                    // 创建新的Image对象进行预加载
                    const tempImage = new Image();
                    tempImage.src = img.dataset.original;

                    // 图片加载成功处理
                    tempImage.onload = () => {
                        // 将实际图片URL赋给src属性
                        img.src = img.dataset.original;

                        // 添加加载完成样式
                        img.style.opacity = '1';

                        // 移除不再需要的属性
                        img.removeAttribute('data-original');
                        img.removeAttribute('lazyload');

                        // 更新计数器
                        loadedImageCount++;
                        updateDebugInfo();

                        // 检查是否所有图片都已加载
                        hideGlobalSpinner();
                    };

                    // 图片加载失败处理
                    tempImage.onerror = () => {
                        console.error(`图片加载失败: ${img.dataset.original}`);
                        img.alt = "图片加载失败";

                        // 移除属性，避免重复尝试
                        img.removeAttribute('data-original');
                        img.removeAttribute('lazyload');

                        // 更新计数器
                        loadedImageCount++;
                        updateDebugInfo();

                        // 检查是否所有图片都已加载
                        hideGlobalSpinner();
                    };
                }
            });
        }

        // 添加事件监听
        window.addEventListener('scroll', lazyLoad);
        window.addEventListener('resize', lazyLoad);
        document.addEventListener('DOMContentLoaded', () => {
            // 初始加载可视区域内的图片
            lazyLoad();
            // 初始更新调试信息
            updateDebugInfo();
        });

        // 添加节流函数优化性能
        let isThrottled = false;
        const throttle = (func, limit) => {
            return function () {
                if (!isThrottled) {
                    func();
                    isThrottled = true;
                    setTimeout(() => {
                        isThrottled = false;
                    }, limit);
                }
            };
        };

        // 应用节流
        window.addEventListener('scroll', throttle(lazyLoad, 200));
    </script>
</body>

</html>